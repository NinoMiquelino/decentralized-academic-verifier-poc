<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DID/VC PoC - Identidade Descentralizada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 900px; padding: 20px; }
        .card { margin-bottom: 20px; }
        /* Otimização Mobile */
        @media (max-width: 768px) {
            h1 { font-size: 1.5rem; }
            .card-body { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4"> POC: Verificador de Certificados com DID</h1>
        
        <div class="card bg-light">
            <div class="card-header"><h4>1. Setup Inicial: Criação de DIDs</h4></div>
            <div class="card-body">
                <button id="setupBtn" class="btn btn-primary w-100">Registrar DIDs (Emissor e Titular)</button>
                <div id="setupOutput" class="mt-3 small text-break"></div>
            </div>
        </div>

        <div class="card border-primary">
            <div class="card-header bg-primary text-white"><h4>2. Emissão (Instituição de Ensino)</h4></div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Nome do Curso:</label>
                    <input type="text" id="courseName" class="form-control" value="Engenharia de Software">
                </div>
                <div class="mb-3">
                    <label class="form-label">Nota Final:</label>
                    <input type="text" id="courseGrade" class="form-control" value="A+">
                </div>
                <button id="issueBtn" class="btn btn-success w-100" disabled>Emitir Credencial Verificável (VC)</button>
                <div id="issueOutput" class="mt-3 small text-break"></div>
            </div>
        </div>
        
        <div class="card border-danger">
            <div class="card-header bg-danger text-white"><h4>3. Verificação (Empregador/Verificador)</h4></div>
            <div class="card-body">
                <div class="alert alert-info" role="alert">
                    <p class="mb-0">Cole aqui a Credencial Verificável (VC) gerada no Passo 2 (simulando a apresentação pela Carteira Digital do Aluno):</p>
                </div>
                <textarea id="vcInput" class="form-control mb-3" rows="5" placeholder="Cole a VC JSON aqui..." disabled></textarea>
                <button id="verifyBtn" class="btn btn-warning w-100" disabled>Verificar Autenticidade da VC</button>
                <div id="verifyOutput" class="mt-3"></div>
            </div>
        </div>

    </div>

    <script>
        let issuerDID = '';
        let holderDID = '';
        let issuerKey = '';
        let latestVC = null;

        document.getElementById('setupBtn').addEventListener('click', async () => {
            const output = document.getElementById('setupOutput');
            output.innerHTML = 'Registrando DIDs...';
            
            try {
                const response = await fetch('/api/setup', { method: 'POST' });
                const data = await response.json();
                
                issuerDID = data.issuerDID;
                holderDID = data.holderDID;
                issuerKey = data.issuerKey;

                output.innerHTML = `
                    <p class="text-success"> ${data.message}</p>
                    <p><strong>Emissor DID:</strong> <code>${issuerDID}</code></p>
                    <p><strong>Titular DID:</strong> <code>${holderDID}</code></p>
                    <p class="text-danger">A chave privada do emissor foi armazenada temporariamente para assinar a VC. (Key: ${issuerKey.substring(0, 30)}...)</p>
                `;
                document.getElementById('issueBtn').disabled = false;
            } catch (error) {
                output.innerHTML = `<p class="text-danger"> Erro no Setup: ${error.message}</p>`;
            }
        });

        document.getElementById('issueBtn').addEventListener('click', async () => {
            const output = document.getElementById('issueOutput');
            const courseName = document.getElementById('courseName').value;
            const courseGrade = document.getElementById('courseGrade').value;
            output.innerHTML = 'Emitindo e assinando VC...';

            const payload = { issuerDID, holderDID, courseName, courseGrade, issuerKey };
            
            try {
                const response = await fetch('/api/issue-vc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                
                if (response.ok) {
                    latestVC = data.verifiableCredential;
                    output.innerHTML = `
                        <p class="text-success"> ${data.message}</p>
                        <p><strong>Credencial (JSON) gerada:</strong></p>
                    `;
                    document.getElementById('vcInput').value = JSON.stringify(latestVC, null, 2);
                    document.getElementById('vcInput').disabled = false;
                    document.getElementById('verifyBtn').disabled = false;
                } else {
                    output.innerHTML = `<p class="text-danger"> Erro na Emissão: ${data}</p>`;
                }
            } catch (error) {
                output.innerHTML = `<p class="text-danger"> Erro de Rede: ${error.message}</p>`;
            }
        });

        document.getElementById('verifyBtn').addEventListener('click', async () => {
            const output = document.getElementById('verifyOutput');
            const vcInput = document.getElementById('vcInput').value;
            output.innerHTML = 'Verificando a autenticidade da assinatura...';
            
            try {
                const verifiableCredential = JSON.parse(vcInput);

                const response = await fetch('/api/verify-vc', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ verifiableCredential })
                });
                const data = await response.json();
                
                if (data.isValid) {
                    output.innerHTML = `
                        <div class="alert alert-success">
                            <h4> Credencial Verificada e Válida!</h4>
                            <p><strong>Emissor:</strong> <code>${data.issuer}</code></p>
                            <p><strong>Titular:</strong> <code>${data.holder}</code></p>
                            <hr>
                            <h6>Dados Comprovados:</h6>
                            <ul>
                                <li>Curso: <strong>${data.data.course}</strong></li>
                                <li>Nota: <strong>${data.data.grade}</strong></li>
                                <li>Data de Conclusão: ${data.data.completionDate}</li>
                            </ul>
                        </div>
                    `;
                } else {
                    output.innerHTML = `
                        <div class="alert alert-danger">
                            <h4> Verificação Falhou!</h4>
                            <p>A assinatura digital é inválida ou o DID do emissor não pôde ser resolvido.</p>
                            <p><strong>Motivo:</strong> ${data.reason}</p>
                        </div>
                    `;
                }
            } catch (error) {
                output.innerHTML = `<p class="text-danger"> Erro na Verificação (Verifique o JSON): ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>